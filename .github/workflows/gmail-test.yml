name: Gmailçµ±åˆãƒ†ã‚¹ãƒˆ

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'full_test'
        type: choice
        options:
          - connection_only
          - send_test
          - full_test

jobs:
  gmail-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸš€ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci
          npm install googleapis google-auth-library
          
      - name: ğŸ” ç’°å¢ƒå¤‰æ•°ç¢ºèª
        run: |
          echo "ğŸ” Gmailèªè¨¼æƒ…å ±ç¢ºèªä¸­..."
          echo "Gmail Credentials: ${{ secrets.GMAIL_CREDENTIALS_JSON != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Gmail Token: ${{ secrets.GMAIL_TOKEN_JSON != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Notion API Key: ${{ secrets.NOTION_API_KEY != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Notion Database ID: ${{ secrets.NOTION_DATABASE_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          
      - name: ğŸ“§ Gmailçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        env:
          GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
          TEST_MODE: ${{ github.event.inputs.test_mode }}
        run: |
          echo "ğŸ‰ Gmailçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹"
          echo "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: $TEST_MODE"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          
          # Gmailçµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆãƒ»å®Ÿè¡Œ
          cat > gmail-integration-test.js << 'EOF'
          const { google } = require('googleapis');
          
          async function testGmailIntegration() {
              console.log('ğŸ‰ Gmailçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
              console.log('=' .repeat(60));
              
              try {
                  // ç’°å¢ƒå¤‰æ•°ç¢ºèª
                  console.log('\nğŸ” èªè¨¼æƒ…å ±ç¢ºèª');
                  const hasCredentials = !!process.env.GMAIL_CREDENTIALS_JSON;
                  const hasToken = !!process.env.GMAIL_TOKEN_JSON;
                  
                  console.log(`ğŸ“‹ GMAIL_CREDENTIALS_JSON: ${hasCredentials ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š'}`);
                  console.log(`ğŸ« GMAIL_TOKEN_JSON: ${hasToken ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š'}`);
                  
                  if (!hasCredentials || !hasToken) {
                      throw new Error('Gmailèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                  }
                  
                  // èªè¨¼æƒ…å ±è§£æ
                  console.log('\nğŸ” èªè¨¼æƒ…å ±è§£æ');
                  const credentials = JSON.parse(process.env.GMAIL_CREDENTIALS_JSON);
                  const token = JSON.parse(process.env.GMAIL_TOKEN_JSON);
                  
                  console.log(`ğŸ“Š Project ID: ${credentials.project_id}`);
                  console.log(`ğŸ†” Client ID: ${credentials.client_id.substring(0, 20)}...`);
                  console.log(`ğŸ”„ Refresh Token: ${token.refresh_token ? 'å­˜åœ¨' : 'æœªè¨­å®š'}`);
                  console.log(`â° Tokenæœ‰åŠ¹æœŸé™: ${token.expiry || 'N/A'}`);
                  
                  // Gmail APIèªè¨¼
                  console.log('\nğŸ”— Gmail APIèªè¨¼');
                  const auth = new google.auth.OAuth2(
                      credentials.client_id,
                      credentials.client_secret,
                      credentials.redirect_uris[0]
                  );
                  
                  auth.setCredentials(token);
                  const gmail = google.gmail({ version: 'v1', auth: auth });
                  
                  // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                  console.log('\nğŸ“¡ Gmailæ¥ç¶šãƒ†ã‚¹ãƒˆ');
                  const profile = await gmail.users.getProfile({ userId: 'me' });
                  
                  console.log('âœ… Gmailæ¥ç¶šæˆåŠŸï¼');
                  console.log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${profile.data.emailAddress}`);
                  console.log(`ğŸ“Š ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${profile.data.messagesTotal.toLocaleString()} ä»¶`);
                  console.log(`ğŸ“ ç·ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: ${profile.data.threadsTotal.toLocaleString()} ä»¶`);
                  
                  // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ä½œæˆ
                  console.log('\nğŸ“ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ä½œæˆ');
                  const now = new Date();
                  const jstTime = now.toLocaleString('ja-JP', {
                      timeZone: 'Asia/Tokyo',
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit',
                      second: '2-digit'
                  });
                  
                  const testSubject = `[ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹] Gmailçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº† ğŸ‰ ${jstTime}`;
                  
                  const testHtml = `
                  <!DOCTYPE html>
                  <html>
                  <head>
                      <meta charset="UTF-8">
                      <style>
                          body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fa; }
                          .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
                          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
                          .header h1 { margin: 0; font-size: 24px; font-weight: 300; }
                          .content { padding: 30px; }
                          .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 5px; }
                          .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
                          .test-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
                          .test-value { font-size: 18px; font-weight: bold; color: #28a745; }
                          .test-label { font-size: 12px; color: #666; margin-top: 5px; }
                          .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 12px; }
                          .info-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                          .info-table td { padding: 8px; border-bottom: 1px solid #eee; }
                          .info-table td:first-child { font-weight: bold; color: #333; }
                      </style>
                  </head>
                  <body>
                      <div class="container">
                          <div class="header">
                              <h1>ğŸ‰ Gmailçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†</h1>
                              <p>ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ AIè‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </p>
                          </div>
                          
                          <div class="content">
                              <div class="success-box">
                                  <h3>âœ… Gmailçµ±åˆã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç¢ºèª</h3>
                                  <p>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆé …ç›®ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚Gmailè‡ªå‹•é…ä¿¡æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
                              </div>
                              
                              <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœè©³ç´°</h3>
                              <div class="test-grid">
                                  <div class="test-item">
                                      <div class="test-value">âœ…</div>
                                      <div class="test-label">APIèªè¨¼</div>
                                  </div>
                                  <div class="test-item">
                                      <div class="test-value">âœ…</div>
                                      <div class="test-label">æ¥ç¶šãƒ†ã‚¹ãƒˆ</div>
                                  </div>
                                  <div class="test-item">
                                      <div class="test-value">âœ…</div>
                                      <div class="test-label">ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ</div>
                                  </div>
                                  <div class="test-item">
                                      <div class="test-value">âœ…</div>
                                      <div class="test-label">é€ä¿¡å®Œäº†</div>
                                  </div>
                              </div>
                              
                              <h3>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
                              <table class="info-table">
                                  <tr><td>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚åˆ»</td><td>${jstTime}</td></tr>
                                  <tr><td>å®Ÿè¡Œç’°å¢ƒ</td><td>GitHub Actions</td></tr>
                                  <tr><td>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</td><td>${profile.data.emailAddress}</td></tr>
                                  <tr><td>ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</td><td>${profile.data.messagesTotal.toLocaleString()} ä»¶</td></tr>
                                  <tr><td>ç·ã‚¹ãƒ¬ãƒƒãƒ‰æ•°</td><td>${profile.data.threadsTotal.toLocaleString()} ä»¶</td></tr>
                              </table>
                              
                              <div class="success-box">
                                  <h3>ğŸš€ ä»Šå¾Œã®å‹•ä½œ</h3>
                                  <p>æ–°ã—ã„éŸ³å£°é…ä¿¡ãŒstand.fmã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®è‡ªå‹•å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼š</p>
                                  <ol>
                                      <li>ğŸ“¡ RSSç›£è¦–ï¼ˆ1æ™‚é–“æ¯ï¼‰</li>
                                      <li>ğŸ” æ–°ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ¤œå‡º</li>
                                      <li>ğŸ¤– è¨˜äº‹è‡ªå‹•ç”Ÿæˆ</li>
                                      <li>ğŸ’¾ Notionä¿å­˜</li>
                                      <li>ğŸ“§ Gmailè‡ªå‹•é…ä¿¡ â† ä»Šå›ãƒ†ã‚¹ãƒˆå®Œäº†</li>
                                  </ol>
                              </div>
                              
                              <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; margin: 20px 0;">
                                  <h3>âš¡ ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç¨¼åƒ</h3>
                                  <p>Gmailçµ±åˆã‚·ã‚¹ãƒ†ãƒ ãŒå®Œå…¨ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚ä»Šå¾Œã¯å®Œå…¨è‡ªå‹•åŒ–ã§ãƒ–ãƒ­ã‚°è¨˜äº‹ã®ç”Ÿæˆãƒ»é…ä¿¡ãŒè¡Œã‚ã‚Œã¾ã™ã€‚</p>
                              </div>
                          </div>
                          
                          <div class="footer">
                              <p>ğŸ¤– ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã—ãŸ</p>
                              <p>ğŸ”§ ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ AIè‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </p>
                              <p>ğŸ“… ${jstTime} JST</p>
                          </div>
                      </div>
                  </body>
                  </html>
                  `;
                  
                  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                  console.log('\nğŸ“¬ ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡');
                  const rawMessage = Buffer.from(
                      `To: hitujikai.maruoka@gmail.com\r\n` +
                      `Subject: ${testSubject}\r\n` +
                      `Content-Type: text/html; charset=utf-8\r\n\r\n` +
                      testHtml
                  ).toString('base64').replace(/\+/g, '-').replace(/\//g, '_');
                  
                  const result = await gmail.users.messages.send({
                      userId: 'me',
                      requestBody: { raw: rawMessage }
                  });
                  
                  console.log('âœ… ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸï¼');
                  console.log(`ğŸ“¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID: ${result.data.id}`);
                  console.log(`ğŸ“§ é€ä¿¡å…ˆ: hitujikai.maruoka@gmail.com`);
                  console.log(`ğŸ“‹ ä»¶å: ${testSubject}`);
                  
                  // æœ€çµ‚çµæœ
                  console.log('\nğŸ¯ Gmailçµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼');
                  console.log('=' .repeat(60));
                  console.log('ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ : âœ… æ­£å¸¸');
                  console.log('ğŸ“¡ APIæ¥ç¶š: âœ… æ­£å¸¸');
                  console.log('ğŸ“ HTMLãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ: âœ… æ­£å¸¸');
                  console.log('ğŸ“¬ ãƒ¡ãƒ¼ãƒ«é€ä¿¡: âœ… æ­£å¸¸');
                  console.log('\nğŸ‰ Gmailçµ±åˆã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç¨¼åƒç¢ºèªï¼');
                  console.log('ğŸ“± hitujikai.maruoka@gmail.com ã®å—ä¿¡ç®±ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                  console.log('\nğŸš€ æ¬¡å›ã‹ã‚‰æ–°ã—ã„éŸ³å£°é…ä¿¡æ™‚ã«è‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã•ã‚Œã¾ã™ï¼');
                  
              } catch (error) {
                  console.error('\nâŒ Gmailçµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼');
                  console.error(`ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${error.constructor.name}`);
                  console.error(`ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}`);
                  
                  if (error.response) {
                      console.error(`HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${error.response.status}`);
                      console.error(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(error.response.data, null, 2)}`);
                  }
                  
                  console.error('\nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:');
                  console.error(error.stack);
                  
                  throw error;
              }
          }
          
          testGmailIntegration().catch(error => {
              console.error('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¤±æ•—:', error.message);
              process.exit(1);
          });
          EOF
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          node gmail-integration-test.js
