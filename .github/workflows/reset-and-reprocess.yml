name: ğŸ“§ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

on:
  workflow_dispatch:
    inputs:
      reset_mode:
        description: 'ğŸ”„ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'preview_only'
        type: choice
        options:
          - preview_only
          - test_reset_5
          - full_reset_10
          - full_reset_20
          - gmail_test_only
      confirm_reset:
        description: 'âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®ç¢ºèªï¼ˆYES ã§å®Ÿè¡Œï¼‰'
        required: true
        default: 'NO'
        type: string

jobs:
  reset-and-reprocess:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸš€ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹..."
          npm install
          npm install googleapis google-auth-library @notionhq/client axios xml2js
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
          
      - name: âš ï¸ å®Ÿè¡Œå‰ç¢ºèª
        run: |
          echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ "
          echo "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.reset_mode }}"
          echo "ç¢ºèªãƒ•ãƒ©ã‚°: ${{ github.event.inputs.confirm_reset }}"
          
          if [ "${{ github.event.inputs.confirm_reset }}" != "YES" ] && [ "${{ github.event.inputs.reset_mode }}" != "preview_only" ] && [ "${{ github.event.inputs.reset_mode }}" != "gmail_test_only" ]; then
            echo "âŒ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’ä¼´ã†å‡¦ç†ã«ã¯ç¢ºèªãŒå¿…è¦ã§ã™"
            echo "confirm_reset ã« 'YES' ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          echo "âœ… å®Ÿè¡Œç¢ºèªå®Œäº†"
          
      - name: ğŸ” ç’°å¢ƒå¤‰æ•°ç¢ºèª
        run: |
          echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒç¢ºèªä¸­..."
          echo "Notion API Key: ${{ secrets.NOTION_API_KEY != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Notion Database ID: ${{ secrets.NOTION_DATABASE_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Gmail Credentials: ${{ secrets.GMAIL_CREDENTIALS_JSON != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Gmail Token: ${{ secrets.GMAIL_TOKEN_JSON != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Stand.FM RSS: ${{ secrets.STANDFM_RSS_URL != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          echo "Stand.FM Channel: ${{ secrets.STANDFM_CHANNEL_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}"
          
      - name: ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†å®Ÿè¡Œ
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          GMAIL_CREDENTIALS_JSON: ${{ secrets.GMAIL_CREDENTIALS_JSON }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
          STANDFM_RSS_URL: ${{ secrets.STANDFM_RSS_URL }}
          STANDFM_CHANNEL_ID: ${{ secrets.STANDFM_CHANNEL_ID }}
          RESET_MODE: ${{ github.event.inputs.reset_mode }}
          CONFIRM_RESET: ${{ github.event.inputs.confirm_reset }}
        run: |
          echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
          echo "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $RESET_MODE"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S JST')"
          
          cat > complete-reset-system.js << 'EOF'
          const { Client } = require('@notionhq/client');
          const { google } = require('googleapis');
          const axios = require('axios');
          const xml2js = require('xml2js');
          
          class CompleteResetSystem {
              constructor() {
                  this.notion = new Client({ auth: process.env.NOTION_API_KEY });
                  this.databaseId = process.env.NOTION_DATABASE_ID;
                  this.rssUrl = process.env.STANDFM_RSS_URL;
                  this.resetMode = process.env.RESET_MODE;
                  this.confirmReset = process.env.CONFIRM_RESET;
                  
                  // ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®š
                  this.config = this.getConfig();
                  
                  // Gmailè¨­å®š
                  this.gmailCredentials = JSON.parse(process.env.GMAIL_CREDENTIALS_JSON || '{}');
                  this.gmailToken = JSON.parse(process.env.GMAIL_TOKEN_JSON || '{}');
                  this.gmail = null;
                  
                  console.log(`ğŸ¯ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${this.resetMode}`);
                  console.log(`ğŸ“Š å‡¦ç†äºˆå®š: ${this.config.maxEpisodes} ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰`);
                  console.log(`ğŸ“§ Gmailé€ä¿¡: ${this.config.enableGmail ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
                  console.log(`ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤: ${this.config.deleteData ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
              }
              
              getConfig() {
                  const configs = {
                      'preview_only': {
                          deleteData: false,
                          maxEpisodes: 5,
                          enableGmail: false,
                          description: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãªã—ï¼‰'
                      },
                      'test_reset_5': {
                          deleteData: true,
                          maxEpisodes: 5,
                          enableGmail: true,
                          description: 'ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚»ãƒƒãƒˆï¼ˆ5ä»¶å‡¦ç†ï¼‰'
                      },
                      'full_reset_10': {
                          deleteData: true,
                          maxEpisodes: 10,
                          enableGmail: true,
                          description: 'æ¨™æº–ãƒªã‚»ãƒƒãƒˆï¼ˆ10ä»¶å‡¦ç†ï¼‰'
                      },
                      'full_reset_20': {
                          deleteData: true,
                          maxEpisodes: 20,
                          enableGmail: true,
                          description: 'å¤§é‡ãƒªã‚»ãƒƒãƒˆï¼ˆ20ä»¶å‡¦ç†ï¼‰'
                      },
                      'gmail_test_only': {
                          deleteData: false,
                          maxEpisodes: 3,
                          enableGmail: true,
                          description: 'Gmailé€ä¿¡ãƒ†ã‚¹ãƒˆã®ã¿'
                      }
                  };
                  
                  return configs[this.resetMode] || configs['preview_only'];
              }
              
              async initializeGmail() {
                  if (!this.config.enableGmail) {
                      console.log('ğŸ“§ Gmailæ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™');
                      return false;
                  }
                  
                  try {
                      console.log('\nğŸ“§ GmailåˆæœŸåŒ–ä¸­...');
                      const auth = new google.auth.OAuth2(
                          this.gmailCredentials.client_id,
                          this.gmailCredentials.client_secret,
                          this.gmailCredentials.redirect_uris[0]
                      );
                      auth.setCredentials(this.gmailToken);
                      this.gmail = google.gmail({ version: 'v1', auth: auth });
                      
                      const profile = await this.gmail.users.getProfile({ userId: 'me' });
                      console.log(`âœ… GmailåˆæœŸåŒ–æˆåŠŸ: ${profile.data.emailAddress}`);
                      return true;
                      
                  } catch (error) {
                      console.log(`âš ï¸ GmailåˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                      return false;
                  }
              }
              
              async resetNotionDatabase() {
                  if (!this.config.deleteData) {
                      console.log('\nğŸ“‹ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰');
                      return 0;
                  }
                  
                  try {
                      console.log('\nğŸ—‘ï¸ Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆé–‹å§‹');
                      
                      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—
                      let hasMore = true;
                      let nextCursor = undefined;
                      let deletedCount = 0;
                      let totalCount = 0;
                      
                      // ã¾ãšç·æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                      console.log('ğŸ“Š æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ•°ç¢ºèªä¸­...');
                      const countResponse = await this.notion.databases.query({
                          database_id: this.databaseId,
                          page_size: 1
                      });
                      
                      if (countResponse.results.length === 0) {
                          console.log('ğŸ“ å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                          return 0;
                      }
                      
                      console.log('ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–‹å§‹...');
                      
                      hasMore = true;
                      nextCursor = undefined;
                      
                      while (hasMore && deletedCount < 100) { // å®‰å…¨ã®ãŸã‚ä¸Šé™è¨­å®š
                          const response = await this.notion.databases.query({
                              database_id: this.databaseId,
                              start_cursor: nextCursor,
                              page_size: 20
                          });
                          
                          // ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
                          for (const page of response.results) {
                              try {
                                  const title = page.properties.Title?.title?.[0]?.text?.content || 'ç„¡é¡Œ';
                                  
                                  await this.notion.pages.update({
                                      page_id: page.id,
                                      archived: true
                                  });
                                  deletedCount++;
                                  
                                  if (deletedCount % 5 === 0) {
                                      console.log(`ğŸ—‘ï¸ å‰Šé™¤ä¸­... ${deletedCount} ä»¶å®Œäº†`);
                                  }
                                  
                                  // APIåˆ¶é™å¯¾ç­–
                                  await new Promise(resolve => setTimeout(resolve, 100));
                                  
                              } catch (error) {
                                  console.log(`âš ï¸ ãƒšãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                              }
                          }
                          
                          hasMore = response.has_more;
                          nextCursor = response.next_cursor;
                      }
                      
                      console.log(`âœ… Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†: ${deletedCount} ä»¶å‰Šé™¤`);
                      return deletedCount;
                      
                  } catch (error) {
                      console.error(`âŒ Notionãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                      throw error;
                  }
              }
              
              async fetchAllEpisodes() {
                  try {
                      console.log('\nğŸ“¡ Stand.FM RSSå–å¾—é–‹å§‹');
                      
                      const response = await axios.get(this.rssUrl, {
                          timeout: 30000,
                          headers: {
                              'User-Agent': 'Mozilla/5.0 (compatible; Maruoka RSS Reader)'
                          }
                      });
                      
                      console.log(`ğŸ“¦ RSSå–å¾—æˆåŠŸ: ${response.data.length.toLocaleString()} æ–‡å­—`);
                      
                      const parser = new xml2js.Parser();
                      const result = await parser.parseStringPromise(response.data);
                      
                      const items = result.rss.channel[0].item || [];
                      console.log(`ğŸ“‹ ç·ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: ${items.length} ä»¶`);
                      
                      // æœ€æ–°ã‹ã‚‰maxEpisodesä»¶ã‚’å‡¦ç†
                      const episodesToProcess = items.slice(0, this.config.maxEpisodes);
                      console.log(`ğŸ¯ å‡¦ç†å¯¾è±¡: ${episodesToProcess.length} ä»¶`);
                      
                      return episodesToProcess;
                      
                  } catch (error) {
                      console.error(`âŒ RSSå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                      throw error;
                  }
              }
              
              async processEpisode(item, index) {
                  try {
                      const title = item.title[0];
                      const pubDate = new Date(item.pubDate[0]);
                      const description = item.description[0];
                      const link = item.link[0];
                      const guid = item.guid[0]._ || item.guid[0];
                      
                      console.log(`\nğŸ“ [${index + 1}/${this.config.maxEpisodes}] å‡¦ç†ä¸­: ${title}`);
                      
                      if (!this.config.deleteData && this.resetMode !== 'gmail_test_only') {
                          console.log(`ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ${title} (å®Ÿéš›ã®å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—)`);
                          return { success: true, preview: true };
                      }
                      
                      // ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆ
                      const blogContent = this.generateBlogContent(title, description, pubDate);
                      
                      let notionPage = null;
                      
                      // Notionä¿å­˜ï¼ˆgmail_test_onlyã®å ´åˆã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
                      if (this.resetMode === 'gmail_test_only') {
                          // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                          const existingData = await this.notion.databases.query({
                              database_id: this.databaseId,
                              page_size: 1,
                              sorts: [{ property: 'Created', direction: 'descending' }]
                          });
                          
                          if (existingData.results.length > 0) {
                              notionPage = existingData.results[0];
                              console.log(`ğŸ“– æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨: ${notionPage.id}`);
                          } else {
                              console.log('âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ–°è¦ä½œæˆã—ã¾ã™');
                              notionPage = await this.saveToNotion({
                                  title: title,
                                  content: blogContent,
                                  episodeId: guid,
                                  pubDate: pubDate,
                                  link: link,
                                  description: description
                              });
                          }
                      } else {
                          notionPage = await this.saveToNotion({
                              title: title,
                              content: blogContent,
                              episodeId: guid,
                              pubDate: pubDate,
                              link: link,
                              description: description
                          });
                      }
                      
                      console.log(`âœ… [${index + 1}] Notionå‡¦ç†å®Œäº†: ${notionPage.id}`);
                      
                      // Gmailé€ä¿¡ï¼ˆæœ€åˆã®3ä»¶ã¾ã§ï¼‰
                      if (this.gmail && index < 3) {
                          await this.sendGmailNotification({
                              title: title,
                              content: blogContent,
                              notionUrl: notionPage.url,
                              episodeIndex: index + 1,
                              totalEpisodes: this.config.maxEpisodes
                          });
                      }
                      
                      return { success: true, notionId: notionPage.id };
                      
                  } catch (error) {
                      console.error(`âŒ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                      return { success: false, error: error.message };
                  }
              }
              
              generateBlogContent(title, description, pubDate) {
                  const jstDate = pubDate.toLocaleString('ja-JP', { 
                      timeZone: 'Asia/Tokyo',
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                  });
                  
                  return `# ${title}
          
          ## ğŸ“… é…ä¿¡æ—¥
          ${jstDate}
          
          ## ğŸ“„ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ¦‚è¦
          ${description}
          
          ## ğŸ™ï¸ ä»Šå›ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          ã“ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§ã¯ã€ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ã®æ—¥å¸¸ã‚„ç¾ŠãŸã¡ã¨ã®ç”Ÿæ´»ã«ã¤ã„ã¦è©³ã—ããŠè©±ã—ã¦ã„ã¾ã™ã€‚å­£ç¯€ã®å¤‰åŒ–ã¨ã¨ã‚‚ã«å¤‰ã‚ã‚‹ç¾Šã®æ§˜å­ã‚„ã€ç‰§å ´ã§ã®å‡ºæ¥äº‹ãªã©ã€ãƒªã‚¹ãƒŠãƒ¼ã®çš†ã•ã‚“ã«æš–ã‹ãªã²ã¨ã¨ãã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚
          
          ## ğŸ‘ ç¾ŠãŸã¡ã®è¿‘æ³
          - å¥åº·çŠ¶æ…‹ã®è¦³å¯Ÿã¨ã‚±ã‚¢
          - å­£ç¯€ã«å¿œã˜ãŸæ”¾ç‰§ç®¡ç†
          - ç¾ŠåŒå£«ã®é–¢ä¿‚æ€§ã®å¤‰åŒ–
          - æ–°ã—ã„ç™ºè¦‹ã‚„æ°—ã¥ã
          
          ## ğŸŒŸ ç¾Šé£¼ã„ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          æ¯æ—¥ã®ç¾Šã®ä¸–è©±ã‚’é€šã—ã¦æ„Ÿã˜ã‚‹ã“ã¨ã‚„å­¦ã‚“ã ã“ã¨ã‚’ã€ãƒªã‚¹ãƒŠãƒ¼ã®çš†ã•ã‚“ã¨å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚å°ã•ãªç™ºè¦‹ã‹ã‚‰å¤§ããªæ°—ã¥ãã¾ã§ã€ç¾Šé£¼ã„ç”Ÿæ´»ã®è±Šã‹ã•ã‚’ãŠä¼ãˆã§ãã‚Œã°å¬‰ã—ã„ã§ã™ã€‚
          
          ## ğŸ’­ ä»Šå›ã®ã¾ã¨ã‚
          ç¾ŠãŸã¡ã¨ã®æ—¥ã€…ã¯æ¯æ—¥ãŒæ–°ã—ã„ç™ºè¦‹ã®é€£ç¶šã§ã™ã€‚ä»Šå›ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§ã‚‚ã€ç¾Šé£¼ã„ã¨ã—ã¦ã®çµŒé¨“ã‚„å­¦ã³ã€ãã—ã¦ç¾ŠãŸã¡ã¨ã®æš–ã‹ãªäº¤æµã‚’ãŠå±Šã‘ã§ãã¾ã—ãŸã€‚
          
          ---
          
          ğŸ¤– **ã“ã®è¨˜äº‹ã¯éŸ³å£°é…ä¿¡ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ**
          ğŸ“… ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
          ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ : ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ AIè‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ `;
              }
              
              async saveToNotion(data) {
                  try {
                      const page = await this.notion.pages.create({
                          parent: { database_id: this.databaseId },
                          properties: {
                              'Title': {
                                  title: [{ text: { content: data.title } }]
                              },
                              'Status': {
                                  select: { name: 'âœ… å®Œäº†' }
                              },
                              'Created': {
                                  date: { start: new Date().toISOString() }
                              },
                              'Episode ID': {
                                  rich_text: [{ text: { content: data.episodeId } }]
                              }
                          },
                          children: [
                              {
                                  object: 'block',
                                  type: 'heading_1',
                                  heading_1: {
                                      rich_text: [{ type: 'text', text: { content: data.title } }]
                                  }
                              },
                              {
                                  object: 'block',
                                  type: 'paragraph',
                                  paragraph: {
                                      rich_text: [{ type: 'text', text: { content: data.content.substring(0, 2000) } }]
                                  }
                              }
                          ]
                      });
                      
                      return page;
                  } catch (error) {
                      console.error(`âŒ Notionä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                      throw error;
                  }
              }
              
              async sendGmailNotification(data) {
                  try {
                      console.log(`ğŸ“§ Gmailé€ä¿¡ [${data.episodeIndex}/${data.totalEpisodes}]: ${data.title}`);
                      
                      const testTime = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
                      const subject = `[ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹] æ–°è¨˜äº‹å®Œæˆ: ${data.title}`;
                      
                      const htmlContent = `
                      <!DOCTYPE html>
                      <html>
                      <head>
                          <meta charset="UTF-8">
                          <style>
                              body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fa; }
                              .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
                              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
                              .header h1 { margin: 0; font-size: 24px; font-weight: 300; }
                              .content { padding: 30px; }
                              .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 5px; }
                              .article-preview { background: #f8f9fa; border-left: 4px solid #007bff; padding: 20px; margin: 20px 0; border-radius: 5px; }
                              .footer { background: #f8f9fa; padding: 20px; text-align: center; color: #666; font-size: 12px; }
                              .btn { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                          </style>
                      </head>
                      <body>
                          <div class="container">
                              <div class="header">
                                  <h1>ğŸ‰ æ–°è¨˜äº‹å®Œæˆé€šçŸ¥</h1>
                                  <p>ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ AIè‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </p>
                                  <p>è¨˜äº‹ ${data.episodeIndex}/${data.totalEpisodes}</p>
                              </div>
                              
                              <div class="content">
                                  <div class="success-box">
                                      <h3>ğŸ“„ ${data.title}</h3>
                                      <p><strong>å‡¦ç†ç•ªå·:</strong> ${data.episodeIndex}/${data.totalEpisodes}</p>
                                      <p><strong>ç”Ÿæˆæ™‚åˆ»:</strong> ${testTime}</p>
                                      <p><strong>å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰:</strong> ${this.resetMode}</p>
                                  </div>
                                  
                                  <div class="article-preview">
                                      <h3>ğŸ“– è¨˜äº‹å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                                      <p style="line-height: 1.6; color: #333;">
                                          ${data.content.substring(0, 300)}...
                                      </p>
                                  </div>
                                  
                                  <div style="text-align: center;">
                                      <a href="${data.notionUrl}" class="btn">ğŸ“ Notionã§è©³ç´°ã‚’ç¢ºèª</a>
                                  </div>
                                  
                                  <div class="success-box">
                                      <h3>ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œçŠ¶æ³</h3>
                                      <ul>
                                          <li>âœ… RSSå–å¾—ãƒ»è§£æ</li>
                                          <li>âœ… ãƒ–ãƒ­ã‚°è¨˜äº‹ç”Ÿæˆ</li>
                                          <li>âœ… Notionè‡ªå‹•ä¿å­˜</li>
                                          <li>âœ… Gmailè‡ªå‹•é…ä¿¡</li>
                                      </ul>
                                  </div>
                              </div>
                              
                              <div class="footer">
                                  <p>ğŸ¤– ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã—ãŸ</p>
                                  <p>ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </p>
                                  <p>ğŸ“… ${testTime} JST</p>
                              </div>
                          </div>
                      </body>
                      </html>
                      `;
                      
                      const message = `To: hitujikai.maruoka@gmail.com\r\nSubject: ${subject}\r\nContent-Type: text/html; charset=utf-8\r\n\r\n${htmlContent}`;
                      
                      const result = await this.gmail.users.messages.send({
                          userId: 'me',
                          requestBody: { 
                              raw: Buffer.from(message).toString('base64').replace(/\+/g, '-').replace(/\//g, '_') 
                          }
                      });
                      
                      console.log(`âœ… Gmailé€ä¿¡æˆåŠŸ [${data.episodeIndex}]: ${result.data.id}`);
                      
                  } catch (error) {
                      console.error(`âŒ Gmailé€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                  }
              }
              
              async run() {
                  try {
                      console.log('ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
                      console.log('=' .repeat(70));
                      console.log(`ğŸ¯ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${this.resetMode}`);
                      console.log(`ğŸ“Š è¨­å®š: ${this.config.description}`);
                      console.log('=' .repeat(70));
                      
                      // GmailåˆæœŸåŒ–
                      await this.initializeGmail();
                      
                      // Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ
                      const deletedCount = await this.resetNotionDatabase();
                      
                      // RSSå…¨ä»¶å–å¾—
                      const episodes = await this.fetchAllEpisodes();
                      
                      // å„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å‡¦ç†
                      console.log('\nğŸ”„ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å‡¦ç†é–‹å§‹');
                      const results = [];
                      
                      for (let i = 0; i < episodes.length; i++) {
                          const result = await this.processEpisode(episodes[i], i);
                          results.push(result);
                          
                          // APIåˆ¶é™å¯¾ç­–
                          if (i < episodes.length - 1) {
                              await new Promise(resolve => setTimeout(resolve, 1500));
                          }
                      }
                      
                      // çµæœã‚µãƒãƒªãƒ¼
                      const successful = results.filter(r => r.success).length;
                      const failed = results.filter(r => !r.success).length;
                      const previewed = results.filter(r => r.preview).length;
                      const gmailSent = Math.min(3, successful - previewed);
                      
                      console.log('\nğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç† çµæœã‚µãƒãƒªãƒ¼');
                      console.log('=' .repeat(70));
                      console.log(`ğŸ¯ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${this.resetMode}`);
                      console.log(`ğŸ—‘ï¸ å‰Šé™¤ã•ã‚ŒãŸè¨˜äº‹: ${deletedCount} ä»¶`);
                      console.log(`ğŸ“ å‡¦ç†å¯¾è±¡ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: ${episodes.length} ä»¶`);
                      console.log(`âœ… æˆåŠŸ: ${successful} ä»¶`);
                      console.log(`âŒ å¤±æ•—: ${failed} ä»¶`);
                      console.log(`ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${previewed} ä»¶`);
                      console.log(`ğŸ“§ Gmailé€ä¿¡: ${gmailSent} ä»¶`);
                      console.log('=' .repeat(70));
                      
                      if (this.resetMode === 'preview_only') {
                          console.log('ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œå®Œäº†');
                          console.log('ğŸ’¡ å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã«ã¯ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                      } else {
                          console.log('ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ&å…¨ä»¶å†å‡¦ç†å®Œäº†ï¼');
                          
                          if (this.gmail && gmailSent > 0) {
                              console.log('ğŸ“± hitujikai.maruoka@gmail.com ã®å—ä¿¡ç®±ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                          }
                      }
                      
                  } catch (error) {
                      console.error(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                      console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
                      throw error;
                  }
              }
          }
          
          // å®Ÿè¡Œ
          const system = new CompleteResetSystem();
          system.run().catch(console.error);
          EOF
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          node complete-reset-system.js
