name: ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹è‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆ

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥21æ™‚ JST = 12æ™‚ UTCï¼‰
  schedule:
    - cron: '0 12 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  process-episodes:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ‘ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install
        
      - name: ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
        run: mkdir -p data
          
      - name: ğŸš€ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å‡¦ç†å®Ÿè¡Œ
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          STANDFM_RSS_URL: ${{ secrets.STANDFM_RSS_URL }}
          STANDFM_CHANNEL_ID: ${{ secrets.STANDFM_CHANNEL_ID }}
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        run: |
          echo "ğŸš€ ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹è‡ªå‹•ãƒ–ãƒ­ã‚°ç”Ÿæˆé–‹å§‹"
          echo "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $TEST_MODE"
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date)"
          
          if [ "$TEST_MODE" = "true" ]; then
            echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
            node src/index.js --test
          else
            echo "ğŸ¯ æœ¬æ ¼ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
            node src/index.js
          fi
          
      - name: ğŸ“Š å‡¦ç†çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ‘ ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ å‡¦ç†çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰:** $(TZ=Asia/Tokyo date)" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰:** ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/processing_summary.json" ]; then
            echo "### ğŸ“‹ å‡¦ç†çµæœ" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/processing_summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ğŸ’¾ çµæœä¿å­˜
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-results-${{ github.run_number }}
          path: data/
          retention-days: 30
          
      - name: ğŸ“§ ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆæœ¬æ ¼ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
        if: failure() && (github.event.inputs.test_mode != 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âŒ ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ æ¯æ—¥å‡¦ç†ã‚¨ãƒ©ãƒ¼ (${new Date().toLocaleDateString('ja-JP')})`;
            const body = `
            ## ğŸ‘ ç¾Šé£¼ã„ã¾ã‚‹ãŠã‹ æ¯æ—¥å‡¦ç†ã‚¨ãƒ©ãƒ¼å ±å‘Š
            
            **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»ï¼ˆJSTï¼‰:** ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID:** ${{ github.run_id }}
            
            ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
            - [å®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ”§ å¯¾å‡¦ãŒå¿…è¦ã§ã™
            1. å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®š
            2. RSS URL ã‚„Notion APIæ¥ç¶šã‚’ç¢ºèª
            3. ä¿®æ­£å¾Œã€æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ
            
            ### ğŸ“… æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œ
            æ˜æ—¥ã®21æ™‚ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation', 'daily-processing']
            });